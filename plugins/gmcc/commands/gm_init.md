---
name: gm_init
description: Initialize the GM-CDE system at the user level. Creates ~/gmcc_ckfs/ root structure including shared plugin template. Run once per machine, then use /gm_repo_init for each repository.
argument-hint: [--force]
disable-model-invocation: true
allowed-tools: Bash, Read, Write, Glob, AskUserQuestion
---

# Initialize GM-CDE System

You are initializing the GM-CDE system at the user level.

**IMPORTANT**: This command creates the system-level `~/gmcc_ckfs/` directory AND the shared plugin template. After running this, use `/gm_repo_init` in each repository you want to use with GM-CDE.

## Pre-Flight Checks

First, verify:
1. `~/gmcc_ckfs/` does NOT already exist (unless `--force` in $ARGUMENTS)

### If Already Initialized (Without --force)
Use AskUserQuestion:
```
GM-CDE system already initialized at ~/gmcc_ckfs/

What would you like to do?
- Reinitialize (wipe ALL repositories) - WARNING: This will delete ALL CKFS data
- Keep existing (exit without changes)
- Initialize a repository instead (run /gm_repo_init)
```

## Directory Structure Creation

Create the system-level structure:

```
~/gmcc_ckfs/
├── README.md
└── gmcc_plugin_template/    # Shared evolution target (copied from live plugin)
    ├── agents/
    ├── commands/
    ├── skills/
    ├── ckfs_templates/
    ├── hooks/
    └── scripts/
```

### Copy Plugin Template

The plugin template is stored at the SYSTEM level (not per-repo) for shared evolution across all repositories.

**Determine plugin source path:**
1. Check if `${CLAUDE_PLUGIN_ROOT}` environment variable is set (preferred - Claude sets this for marketplace plugins)
2. If not set, search common locations:
   - `~/.claude/plugins/cache/gmcc-marketplace/gmcc/*/` (marketplace install)
   - `~/.claude/plugins/gmcc/` (manual install)

```bash
# Find the plugin source
if [ -n "${CLAUDE_PLUGIN_ROOT}" ]; then
    PLUGIN_SRC="${CLAUDE_PLUGIN_ROOT}"
elif [ -d "$HOME/.claude/plugins/cache/gmcc-marketplace/gmcc" ]; then
    # Find latest version in marketplace cache
    PLUGIN_SRC=$(ls -d "$HOME/.claude/plugins/cache/gmcc-marketplace/gmcc"/*/ 2>/dev/null | sort -V | tail -1)
elif [ -d "$HOME/.claude/plugins/gmcc" ]; then
    PLUGIN_SRC="$HOME/.claude/plugins/gmcc"
fi

# Copy to template location
cp -r "$PLUGIN_SRC"/* ~/gmcc_ckfs/gmcc_plugin_template/
```

### README.md
```markdown
# GMCC CKFS (Context Knowledge File System)

This directory contains GM-CDE runtime data for all repositories.

## Structure

```
~/gmcc_ckfs/
├── README.md                    # This file
├── gmcc_plugin_template/        # SHARED evolution target for /gm_evolve
│   ├── agents/
│   ├── commands/
│   ├── skills/
│   ├── ckfs_templates/
│   ├── hooks/
│   └── scripts/
└── {repo_name}/                 # Per-repository CKFS
    ├── REPOSITORY_INDEX.md      # Cross-repo relationships
    ├── GREATER_PURPOSE.md       # Project vision
    ├── SRC_INDEX.md             # Source file index
    ├── FAM_INDEX.md             # Branch index
    ├── CHANGELOG.md             # Change history
    ├── EVOLUTION_LOG.md         # Evolution history
    ├── resource/                # Reference materials
    └── fam/                     # Feature Access Memory
        └── {branch}/            # Per-branch context
            ├── Purpose.md
            ├── Tasks.md
            ├── ChangedFiles.md
            ├── Famalouge.md
            ├── ECLAIR_BRAIN.md
            └── thoughts/
```

## Plugin Template

The `gmcc_plugin_template/` directory is the SHARED evolution target:
- `/gm_evolve` modifies files here first
- After approval, changes sync to the live plugin at `${CLAUDE_PLUGIN_ROOT}`
- Shared across ALL repositories (not per-repo)

## Usage

1. Run `/gm_init` once to create this directory (already done)
2. Run `/gm_repo_init` in each repository to initialize its CKFS
3. Run `/gm_load_branch` or `/gm_feature_dev` to start working

## Environment Variables

Set automatically by SessionStart hook:
- `GMCC_CKFS_ROOT` - This directory (~/gmcc_ckfs)
- `GMCC_REPO_ID` - Current repository name
- `GMCC_REPO_PATH` - Current repo's CKFS path
- `GMCC_FAM_PATH` - Current branch's FAM path
- `GMCC_PLUGIN_ROOT` - Live plugin installation path (set by Claude for marketplace plugins)

---
*Generated by GM-CDE*
```

## Post-Initialization

After creating the structure:

1. **Verify Creation**:
   - Check that `~/gmcc_ckfs/` exists
   - Check that `~/gmcc_ckfs/README.md` was created
   - Check that `~/gmcc_ckfs/gmcc_plugin_template/` was populated

2. **Report Success**:
```
[GMB] GM-CDE system initialized!

Created:
- ~/gmcc_ckfs/
- ~/gmcc_ckfs/README.md
- ~/gmcc_ckfs/gmcc_plugin_template/ (copied from live plugin)

Plugin source: {source path used}

Next steps:
1. Navigate to a git repository
2. Run /gm_repo_init to initialize that repository
3. Start development with /gm_feature_dev or /gm_task

Note: The SessionStart hook will automatically detect git repositories
and set GMCC_* environment variables when you open Claude Code.
```

### If Plugin Copy Fails
```
[GMB] Warning: Could not copy plugin template

Searched locations:
- ${CLAUDE_PLUGIN_ROOT} (not set)
- ~/.claude/plugins/cache/gmcc-marketplace/gmcc/*/ (not found)
- ~/.claude/plugins/gmcc/ (not found)

The system is initialized but /gm_evolve will not work until the template is populated.
You can manually copy: cp -r <plugin_path>/* ~/gmcc_ckfs/gmcc_plugin_template/
```
